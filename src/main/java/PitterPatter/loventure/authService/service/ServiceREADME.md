# AuthService: 비즈니스 로직 서비스 (Service) 🚀

이 문서는 `authService` 내 `service` 패키지의 역할과 구조를 설명합니다. 이 패키지는 인증 과정의 **핵심 비즈니스 로직**을 실제로 수행하는 '엔진' 역할을 담당합니다. `Controller`나 `Handler`로부터 요청을 받아, 데이터베이스와 통신하고 데이터를 가공하여 최종 결과물을 만들어냅니다.

---

## 🚀 서비스 계층의 핵심 역할

서비스 계층은 OAuth2 소셜 로그인 과정에서 다음과 같은 실질적인 작업을 처리합니다.

* **사용자 동기화**: 소셜 플랫폼에서 받아온 사용자 정보를 우리 서비스의 데이터베이스(DB)와 동기화합니다. (신규 회원가입 및 기존 회원 정보 조회/업데이트)
* **상세 비즈니스 규칙 적용**: 단순 DB 조회를 넘어, 이메일 중복 체크, 계정 활성 상태 확인 등 우리 서비스만의 고유한 규칙을 적용합니다.
* **JWT 생성**: 모든 인증 절차가 성공적으로 완료되었을 때, 최종적으로 사용자에게 발급할 Access Token과 Refresh Token을 생성합니다.

---

## 🛠️ 주요 컴포넌트 설명

### `CustomOAuth2UserService.java`

**'1차 관문'이자 '소셜 정보 가공 담당자'**입니다. Spring Security의 OAuth2 로그인 흐름에 가장 먼저 연결되어, 소셜 플랫폼의 원본 데이터를 우리 시스템에 맞게 가공하고 DB와 최초로 연동하는 역할을 합니다.

#### 주요 동작 흐름

1.  **소셜 정보 수신 및 표준화**: Spring Security로부터 받은 사용자 정보를 `GoogleUserInfo`, `KakaoUserInfo` 등 우리 시스템이 사용하기 편한 표준 DTO 객체로 변환합니다.
2.  **최초 DB 조회**: 사용자의 고유 식별자(`providerId`)를 이용해 DB에 이미 가입된 사용자인지 **처음으로 확인**합니다.
3.  **신규 유저 자동 회원가입**: DB에 사용자가 없다면, 받아온 최소한의 정보로 `User` 엔티티를 생성하여 DB에 저장합니다.
4.  **정보 반환**: 처리된 사용자 정보를 Spring Security가 이해할 수 있는 `OAuth2User` 형태로 반환하며 자신의 임무를 마칩니다. 이 단계에서는 JWT 발급과 같은 복잡한 로직은 수행하지 않습니다.

### `AuthService.java`

**'최종 관문'이자 'JWT 발급 총책임자'**입니다. `OAuth2LoginSuccessHandler`에 의해 호출되어, 1차 처리된 정보를 바탕으로 최종 검증을 수행하고 실제 JWT를 발급하는 모든 핵심 로직을 총괄합니다.

#### 주요 동작 흐름 (`processOAuth2Login`)

1.  **상세 검증 수행**: `CustomOAuth2UserService`에는 없었던 더 상세한 비즈니스 규칙을 적용합니다.
    * **이메일 중복 체크**: 다른 소셜 계정으로 동일한 이메일이 가입되어 있는지 확인합니다.
    * **계정 상태 확인**: 사용자의 계정이 `ACTIVE`(활성) 상태인지 최종적으로 검사합니다.
2.  **기존 사용자 정보 업데이트**: 필요시 소셜 플랫폼의 최신 정보로 DB 데이터를 갱신합니다.
3.  **JWT 토큰 생성**: 모든 검증을 통과하면, `JWTUtil`을 호출하여 **Access Token**과 **Refresh Token**을 최종적으로 생성합니다.
4.  **최종 응답 생성**: 생성된 토큰, 사용자 정보, 신규 가입 여부 등을 `AuthResponse` DTO에 담아 `OAuth2LoginSuccessHandler`에게 반환합니다.

#### 토큰 갱신 로직 (`refreshToken`)

Access Token이 만료되었을 때, Refresh Token을 받아 유효성을 검증하고 새로운 Access Token을 재발급해주는 역할을 담당합니다.

---

### 💡 두 서비스의 협력 관계

두 서비스는 역할을 명확히 분리하여 협력합니다.

* `CustomOAuth2UserService`는 **Spring Security와의 연동** 및 **1차적인 DB 동기화**에 집중합니다.
* `AuthService`는 **우리 서비스만의 고유한 비즈니스 규칙** 적용과 **최종적인 JWT 발급**에 집중합니다.

이러한 분리 덕분에 코드가 명확해지고 각자의 책임이 분명해져 유지보수가 용이해집니다.